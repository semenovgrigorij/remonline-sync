<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–Ü—Å—Ç–æ—Ä—ñ—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤</title>
    <link rel="icon" type="image/x-icon" href="./img/favicon.ico" />
    <link rel="shortcut icon" type="image/x-icon" href="./img/favicon.ico" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: Arial, sans-serif;
            background: #667eea;
            padding: 20px
        }

        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 400px;
            margin: 100px auto
        }

        #loginForm {
            width: 100%;
        }

        .login-container h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 20px
        }

        .form-group {
            margin-bottom: 15px
        }

        .form-group label {
            display: block;
            margin-bottom: 5px
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none
        }

        .main-container {
            display: none
        }

        .header {
            background: white;
            border-radius: 5px;
            padding: 5px 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .header h1 {
            font-size: 1.3em;
        }

        .logout-btn {
            padding: 5px 12px;
            background: #f44;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: box-shadow 0.25s ease, transform 0.1s ease;
        }

        .logout-btn:hover {
            box-shadow: 0 4px 12px rgba(244, 68, 68, 0.5);
        }

        .logout-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 6px rgba(244, 68, 68, 0.4);
        }

        .controls {
            background: white;
            border-radius: 5px;
            padding: 5px 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: space-between;
        }

        .controls label {
            font-size: 0.8em;
        }

        .controls select,
        .controls input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px
        }

        .content {
            background: white;
            border-radius: 5px;
            padding: 5px 10px;
        }

        .search-section {
            margin-bottom: 5px;
            display: flex;
            gap: 10px
        }

        .search-input {
            flex: 1;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px
        }

        .search-btn {
            padding: 5px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd
        }

        th {
            background: #f5f5f5
        }

        .history-btn {
            padding: 5px 10px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto
        }

        .modal-content {
            background: white;
            max-width: 1200px;
            margin: 50px auto;
            border-radius: 10px;
            padding: 20px
        }

        .close-modal {
            float: right;
            font-size: 28px;
            cursor: pointer
        }

        .empty {
            text-align: center;
            padding: 5px;
            color: #999
        }

        /* –ü—Ä–µ–ª–æ–∞–¥–µ—Ä –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤ */
        .loading-preloader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 18px;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .loading-subtext {
            font-size: 14px;
            color: #999;
            line-height: 1.5;
            max-width: 400px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—Ä–æ —Ä–æ–∑—ñ—Ä–≤–∞–Ω–Ω—è —Å–µ—Å—ñ—ó */
        .session-expired-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s;
        }

        .session-expired-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
        }

        .session-expired-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .session-expired-title {
            color: #d32f2f;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .session-expired-text {
            color: #666;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        .session-expired-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .session-expired-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ —Ç–æ–≤–∞—Ä—ñ–≤ –∑ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ—é —à–∞–ø–∫–æ—é */
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            position: relative;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .table-container table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 0;
        }

        .table-container thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f5f5f5;
        }

        .table-container thead th {
            background: #f5f5f5;
            position: sticky;
            top: 0;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ —ñ—Å—Ç–æ—Ä—ñ—ó */
        .modal-content {
            background: white;
            max-width: 1400px;
            /* –ó–±—ñ–ª—å—à–µ–Ω–æ –¥–ª—è –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö —Å—Ç–æ–≤–ø—Ü—ñ–≤ */
            margin: 50px auto;
            border-radius: 10px;
            padding: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* –¢–∞–±–ª–∏—Ü—è —ñ—Å—Ç–æ—Ä—ñ—ó –∑ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ—é —à–∞–ø–∫–æ—é */
        #historyContent {
            max-height: 500px;
            overflow-y: auto;
            position: relative;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 15px;
        }

        #historyContent table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 0;
        }

        #historyContent thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f5f5f5;
        }

        #historyContent thead th {
            background: #f5f5f5;
            position: sticky;
            top: 0;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        #historyContent tbody td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        /* –ö–æ–ª—å–æ—Ä–æ–≤—ñ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –¥–ª—è +/- */
        .plus-value {
            color: #4caf50;
            font-weight: bold;
        }

        .minus-value {
            color: #f44336;
            font-weight: bold;
        }

        /* –°—Ç–æ–≤–ø–µ—Ü—å –∑–∞–ª–∏—à–∫—É */
        .balance-cell {
            font-weight: bold;
            color: #333;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è —ñ–º–µ–Ω—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ */
        .employee-name {
            color: #666;
            font-size: 13px;
        }

        /* Loader –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ–º–µ–Ω—ñ */
        .employee-loading {
            color: #999;
            font-style: italic;
            font-size: 12px;
        }

        /* –ü–æ–∫—Ä–∞—â–µ–Ω–∞ —à–∏—Ä–∏–Ω–∞ —Å—Ç–æ–≤–ø—Ü—ñ–≤ */
        #historyContent th:nth-child(1),
        #historyContent td:nth-child(1) {
            width: 100px;
            /* –î–∞—Ç–∞ */
        }

        #historyContent th:nth-child(2),
        #historyContent td:nth-child(2) {
            width: 100px;
            /* –î–æ–∫—É–º–µ–Ω—Ç */
        }

        #historyContent th:nth-child(3),
        #historyContent td:nth-child(3) {
            width: 150px;
            /* –•—Ç–æ —Å—Ç–≤–æ—Ä–∏–≤ */
        }

        #historyContent th:nth-child(4),
        #historyContent td:nth-child(4) {
            width: 150px;
            /* –û–ø–µ—Ä–∞—Ü—ñ—è */
        }

        #historyContent th:nth-child(5),
        #historyContent td:nth-child(5) {
            width: 200px;
            /* –ö–ª—ñ—î–Ω—Ç */
        }

        #historyContent th:nth-child(6),
        #historyContent td:nth-child(6) {
            width: 80px;
            /* + */
            text-align: right;
        }

        #historyContent th:nth-child(7),
        #historyContent td:nth-child(7) {
            width: 80px;
            /* - */
            text-align: right;
        }

        #historyContent th:nth-child(8),
        #historyContent td:nth-child(8) {
            width: 100px;
            /* –ó–∞–ª–∏—à–æ–∫ */
            text-align: right;
        }

        /* –°–∫—Ä–æ–ª–±–∞—Ä –¥–ª—è webkit –±—Ä–∞—É–∑–µ—Ä—ñ–≤ */
        .table-container::-webkit-scrollbar,
        #historyContent::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track,
        #historyContent::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb,
        #historyContent::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover,
        #historyContent::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Spinner animation */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body>

    <div id="loginContainer" class="login-container">
        <img src="./img/GCAR_LOGO.png" alt="logo" width="50">
        <h1>–Ü—Å—Ç–æ—Ä—ñ—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤</h1>
        <div class="error-message" id="loginError"></div>
        <form id="loginForm">
            <div class="form-group">
                <label>–õ–æ–≥—ñ–Ω –∞–±–æ Email</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="password" required>
            </div>
            <div class="form-group">
                <label>API Token</label>
                <input type="text" id="apiToken" required>
            </div>
            <button type="submit" class="login-btn" id="loginBtn">–ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—å</button>
        </form>
    </div>

    <div id="mainContainer" class="main-container">
        <div class="header">
            <img src="./img/GCAR_LOGO.png" alt="golo" width="30">
            <h1>–Ü—Å—Ç–æ—Ä—ñ—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤</h1>
            <div>
                <!-- <span id="userEmail"></span> -->
                <button class="logout-btn" id="logoutBtn">–í–∏–π—Ç–∏</button>
            </div>
        </div>
        <div class="controls">
            <label>–õ–æ–∫–∞—Ü—ñ—è:</label>
            <select id="branchSelect">
                <option value="">‚Äî –≤–∏–±–µ—Ä—ñ—Ç—å ‚Äî</option>
            </select>
            <label>–°–∫–ª–∞–¥:</label>
            <select id="warehouseSelect">
                <option value="">‚Äî –≤–∏–±–µ—Ä—ñ—Ç—å ‚Äî</option>
            </select>
            <label>–î–∞—Ç–∞:</label>
            <input type="date" id="startDate" lang="uk">
        </div>
        <div class="content">
            <div class="search-section">
                <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ—à—É–∫...">
                <button class="search-btn" id="searchBtn">üîç</button>
                <button class="search-btn" id="resetBtn" style="background: #f44; display: none;">‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è</button>
            </div>
            <div id="tableContainer" class="empty">–í–∏–±–µ—Ä—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ —Å–∫–ª–∞–¥</div>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">√ó</span>
            <div id="historyStats"></div>
            <div id="historyContent"></div>
        </div>
    </div>

    <!-- –î–æ–¥–∞–π—Ç–µ —Ü–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä–∏–≤–∞—é—á–∏–º —Ç–µ–≥–æ–º </body> -->

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—Ä–æ —Ä–æ–∑—ñ—Ä–≤–∞–Ω–Ω—è —Å–µ—Å—ñ—ó -->
    <div id="sessionExpiredModal" class="session-expired-modal">
        <div class="session-expired-content">
            <div class="session-expired-icon">‚ö†Ô∏è</div>
            <div class="session-expired-title">–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É</div>
            <div class="session-expired-text">
                –ü—ñ–¥ –≤–∞—à–∏–º –æ–±–ª—ñ–∫–æ–≤–∏–º –∑–∞–ø–∏—Å–æ–º –±—É–≤ –≤–∏–∫–æ–Ω–∞–Ω–∏–π –≤—Ö—ñ–¥ –∑ —ñ–Ω—à–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞ –∞–±–æ –ø—Ä–∏—Å—Ç—Ä–æ—é,
                —Ç–æ–º—É –ø–æ—Ç–æ—á–Ω–∞ —Å–µ—Å—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ä–æ–∑—ñ—Ä–≤–∞–Ω–∞.
            </div>
            <button class="session-expired-btn" onclick="reauthorize()">–ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—å</button>
        </div>
    </div>


    <script>
        // –°–∫—Ä–∏–ø—Ç –¥–ª—è  –ø–æ–∫–∞–∑—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –ø—Ä–æ —Ä–æ–∑—ñ—Ä–≤–∞–Ω–Ω—è —Å–µ—Å—ñ—ó

        function showSessionExpiredModal() {
            document.getElementById('sessionExpiredModal').style.display = 'block';
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ—ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
        function reauthorize() {
            document.getElementById('sessionExpiredModal').style.display = 'none';
            // –ü–æ–∫–∞–∑—É—î–º–æ —Ñ–æ—Ä–º—É –ª–æ–≥—ñ–Ω—É
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
            // –û—á–∏—â—É—î–º–æ –ø–æ–ª—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ, –∑–∞–ª–∏—à—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ)
            // document.getElementById('password').value = '';
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π API
        async function fetchWithSessionCheck(url, options = {}) {
            try {
                const response = await fetch(url, options);

                // ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ 401 –ü–ï–†–ï–î –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON
                if (response.status === 401) {
                    console.warn('‚ö†Ô∏è –°–µ—Å—ñ—è —Ä–æ–∑—ñ—Ä–≤–∞–Ω–∞ (401)');
                    showSessionExpiredModal();
                    return null;
                }

                const data = await response.json();

                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø–æ–º–∏–ª–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
                if (!data.success && data.error) {
                    if (data.error.includes('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ') ||
                        data.error.includes('Unauthorized')) {
                        console.warn('‚ö†Ô∏è –°–µ—Å—ñ—è —Ä–æ–∑—ñ—Ä–≤–∞–Ω–∞');
                        showSessionExpiredModal();
                        return null;
                    }
                }

                return data;
            } catch (error) {
                console.error('‚ùå –ü–æ–º–∏–ª–∫–∞:', error);
                throw error;
            }
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç
        const API = '';
        const loginContainer = document.getElementById('loginContainer');
        const mainContainer = document.getElementById('mainContainer');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const username = document.getElementById('username');
        const password = document.getElementById('password');
        const apiToken = document.getElementById('apiToken');
        const userEmail = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');
        const branchSelect = document.getElementById('branchSelect');
        const warehouseSelect = document.getElementById('warehouseSelect');
        const startDate = document.getElementById('startDate');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const resetBtn = document.getElementById('resetBtn');
        const tableContainer = document.getElementById('tableContainer');
        const historyModal = document.getElementById('historyModal');
        const closeModal = document.getElementById('closeModal');
        const historyStats = document.getElementById('historyStats');
        const historyContent = document.getElementById('historyContent');

        const branches = [
            { name: "01.1_G_CAR_KY", id: 134397 }, { name: "02.1_G_CAR_LV", id: 137783 }, { name: "02.2_G_CAR_LV", id: 170450 },
            { name: "02.3_G_CAR_LV", id: 198255 }, { name: "03_G_CAR_OD", id: 171966 }, { name: "07_G_CAR_VN", id: 189625 },
            { name: "08_G_CAR_PLT", id: 147848 }, { name: "09_G_CAR_IF", id: 186381 }, { name: "15_G_CAR_CK", id: 185929 },
            { name: "16_G_CAR_CV", id: 155210 }, { name: "18.1_G_CAR_LU", id: 158504 }, { name: "18.2_G_CAR_LU", id: 177207 },
            { name: "18.3_G_CAR_LU", id: 205571 }, { name: "19.1_G_CAR_RV", id: 154905 }, { name: "19.2_G_CAR_RV", id: 184657 }
        ];
        branches.forEach(b => { const o = document.createElement('option'); o.value = b.id; o.textContent = b.name; branchSelect.appendChild(o); });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            console.log('üîê –°–ø—Ä–æ–±–∞ –∞–≤—Ç–æ—Ä—ñ–∑–∞—Ü—ñ—ó...');

            const u = username.value.trim();
            const p = password.value.trim();
            const t = apiToken.value.trim();

            console.log('üë§ Username:', u);
            console.log('üîë Password length:', p.length);
            console.log('üé´ API Token length:', t.length);

            if (!u || !p || !t) {
                loginError.textContent = '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è';
                loginError.style.display = 'block';
                console.error('‚ùå –ü–æ—Ä–æ–∂–Ω—ñ –ø–æ–ª—è');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = '–í—Ö—ñ–¥...';

            // –¢–∞–π–º–µ—Ä –¥–ª—è –ø–æ–∫–∞–∑—É —á–∞—Å—É
            let elapsed = 0;
            const loginTimer = setInterval(() => {
                elapsed++;
                if (elapsed <= 30) {
                    loginBtn.textContent = `–í—Ö—ñ–¥... (${elapsed}—Å)`;
                } else {
                    loginBtn.textContent = `–í—Ö—ñ–¥... (${elapsed}—Å - –º–∞–π–∂–µ –≥–æ—Ç–æ–≤–æ)`;
                }
            }, 1000);

            loginError.style.display = 'none';

            try {
                console.log('üì° –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç –Ω–∞ /api/login...');

                const r = await fetch(API + '/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username: u, password: p, apiToken: t })
                });

                console.log('üì• Response status:', r.status);
                console.log('üì• Response ok:', r.ok);

                const d = await r.json();
                console.log('üì¶ Response data:', d);

                if (d.success) {
                    console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞!');
                    loginContainer.style.display = 'none';
                    mainContainer.style.display = 'block';
                } else {
                    console.error('‚ùå –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –Ω–µ—É—Å–ø—ñ—à–Ω–∞:', d.error);
                    loginError.textContent = d.error || '–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å';
                    loginError.style.display = 'block';
                }
            } catch (err) {
                console.error('‚ùå –ü–û–ú–ò–õ–ö–ê:', err);
                console.error('‚ùå Stack:', err.stack);
                loginError.textContent = "–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º";
                loginError.style.display = 'block';
            } finally {
                // –ó—É–ø–∏–Ω—è—î–º–æ —Ç–∞–π–º–µ—Ä
                if (typeof loginTimer !== "undefined") clearInterval(loginTimer);

                loginBtn.disabled = false;
                loginBtn.textContent = '–ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—å';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await fetch(API + '/api/logout', { method: 'POST', credentials: 'include' });
            location.reload();
        });

        branchSelect.addEventListener('change', async () => {
            const bid = branchSelect.value;
            warehouseSelect.innerHTML = '<option value="">‚Äî –≤–∏–±–µ—Ä—ñ—Ç—å ‚Äî</option>';
            tableContainer.innerHTML = '<div class="empty">–í–∏–±–µ—Ä—ñ—Ç—å —Å–∫–ª–∞–¥</div>';
            if (!bid) return;
            try {
                // const r = await fetch(API + '/api/warehouses?branch_id=' + bid, { credentials: 'include' });
                // const d = await r.json();
                const d = await fetchWithSessionCheck(API + '/api/warehouses?branch_id=' + bid, { credentials: 'include' });
                if (!d) return;
                if (d.success && d.warehouses) {
                    d.warehouses.forEach(w => { const o = document.createElement('option'); o.value = w.id; o.textContent = w.title; warehouseSelect.appendChild(o); });
                }
            } catch (e) { console.error(e); }
        });

        async function loadWarehouseGoods() {
            const wid = warehouseSelect.value;
            if (!wid) { tableContainer.innerHTML = '<div class="empty">–í–∏–±–µ—Ä—ñ—Ç—å —Å–∫–ª–∞–¥</div>'; return; }

            //  –ö—Ä–∞—Å–∏–≤–∏–π –ø—Ä–µ–ª–æ–∞–¥–µ—Ä
            tableContainer.innerHTML = `
        <div class="loading-preloader">
            <div class="loading-spinner"></div>
            <div class="loading-text">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤...</div>
            <div class="loading-subtext">–¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ –¥–æ 3 —Ö–≤–∏–ª–∏–Ω –¥–ª—è —Å–∫–ª–∞–¥—ñ–≤ –∑ –≤–µ–ª–∏–∫–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Ç–æ–≤–∞—Ä—ñ–≤</div>
        </div>
    `;

            resetBtn.style.display = 'none';
            searchInput.value = '';

            try {
                console.log('üîÑ –°–∫–ª–∞–¥:', wid);
                const d = await fetchWithSessionCheck(API + '/api/warehouse-all-goods/' + wid, { credentials: 'include' });

                if (!d) return; // –°–µ—Å—ñ—è —Ä–æ–∑—ñ—Ä–≤–∞–Ω–∞

                console.log('üì¶ –í—ñ–¥–ø–æ–≤—ñ–¥—å:', d);
                console.log('üìä –¢–æ–≤–∞—Ä—ñ–≤:', d.goods ? d.goods.length : 0);

                if (d.success && d.goods && d.goods.length > 0) {
                    console.log('‚úÖ –ë—É–¥—É—î–º–æ —Ç–∞–±–ª–∏—Ü—é:', d.goods.length);

                    let h = '<p><strong>–¢–æ–≤–∞—Ä—ñ–≤: ' + d.goods.length + '</strong></p>';
                    h += '<div class="table-container">'; // ‚Üê –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑—ñ —Å–∫—Ä–æ–ª–æ–º
                    h += '<table><thead><tr><th>‚Ññ</th><th>–§–æ—Ç–æ</th><th>–ù–∞–∑–≤–∞</th><th>–ê—Ä—Ç–∏–∫—É–ª</th><th>–ó–∞–ª–∏—à–æ–∫</th><th>–î—ñ—è</th></tr></thead><tbody>';

                    d.goods.forEach((g, i) => {
                        const img = g.image && g.image.length > 0 ? g.image[0] : '';
                        const imgH = img ? '<img src="' + img + '" style="width:50px;height:50px;object-fit:cover;border-radius:4px;">' : '‚Äî';
                        h += '<tr>';
                        h += '<td>' + (i + 1) + '</td>';
                        h += '<td>' + imgH + '</td>';
                        h += '<td>' + g.title + '</td>';
                        h += '<td>' + (g.article || '‚Äî') + '</td>';
                        h += '<td><strong>' + (g.residue || 0) + '</strong></td>';
                        h += '<td><button class="history-btn" onclick="showHistory(' + g.id + ',\'' + g.title.replace(/'/g, "\\'") + '\')">–Ü—Å—Ç–æ—Ä—ñ—è</button></td>';
                        h += '</tr>';
                    });

                    h += '</tbody></table>';
                    h += '</div>'; // ‚Üê –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                    tableContainer.innerHTML = h;
                    console.log('‚úÖ –ì–æ—Ç–æ–≤–æ');
                } else {
                    tableContainer.innerHTML = '<div class="empty">–ù–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤</div>';
                }
            } catch (e) {
                console.error('‚ùå', e);
                tableContainer.innerHTML = '<div class="empty">–ü–æ–º–∏–ª–∫–∞</div>';
            }
        }

        warehouseSelect.addEventListener('change', loadWarehouseGoods);

        searchBtn.addEventListener('click', doSearch);
        searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') doSearch(); });


        async function doSearch() {
            const bid = branchSelect.value, wid = warehouseSelect.value, q = searchInput.value.trim();
            if (!bid || !wid) { alert('–í–∏–±–µ—Ä—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é —Ç–∞ —Å–∫–ª–∞–¥'); return; }

            // –ü—Ä–µ–ª–æ–∞–¥–µ—Ä –¥–ª—è –ø–æ—à—É–∫—É
            tableContainer.innerHTML = `
        <div class="loading-preloader">
            <div class="loading-spinner"></div>
            <div class="loading-text">üîç –ü–æ—à—É–∫ —Ç–æ–≤–∞—Ä—ñ–≤...</div>
            <div class="loading-subtext">–ó–∞—á–µ–∫–∞–π—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞...</div>
        </div>
    `;

            try {
                const d = await fetchWithSessionCheck(
                    API + '/api/search-goods?branch_id=' + bid + '&warehouse_id=' + wid + '&query=' + encodeURIComponent(q),
                    { credentials: 'include' }
                );

                if (!d) return; // –°–µ—Å—ñ—è —Ä–æ–∑—ñ—Ä–≤–∞–Ω–∞

                if (d.success && d.goods.length > 0) {
                    let h = '<div class="table-container">'; // ‚Üê –î–æ–¥–∞—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                    h += '<table><thead><tr><th>‚Ññ</th><th>–§–æ—Ç–æ</th><th>–ù–∞–∑–≤–∞</th><th>–ê—Ä—Ç–∏–∫—É–ª</th><th>–ó–∞–ª–∏—à–æ–∫</th><th>–î—ñ—è</th></tr></thead><tbody>';

                    d.goods.forEach((g, i) => {
                        const img = g.image && g.image.length > 0 ? g.image[0] : '';
                        const imgH = img ? '<img src="' + img + '" style="width:50px;height:50px;object-fit:cover;border-radius:4px;">' : '‚Äî';
                        const am = g.amount || g.residue || 0;
                        h += '<tr>';
                        h += '<td>' + (i + 1) + '</td>';
                        h += '<td>' + imgH + '</td>';
                        h += '<td>' + g.title + '</td>';
                        h += '<td>' + (g.article || '‚Äî') + '</td>';
                        h += '<td><strong>' + am + '</strong></td>';
                        h += '<td><button class="history-btn" onclick="showHistory(' + g.id + ',\'' + g.title.replace(/'/g, "\\'") + '\')">–Ü—Å—Ç–æ—Ä—ñ—è</button></td>';
                        h += '</tr>';
                    });

                    h += '</tbody></table>';
                    h += '</div>'; // ‚Üê –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                    tableContainer.innerHTML = h;
                    resetBtn.style.display = 'inline-block';
                } else {
                    tableContainer.innerHTML = '<div class="empty">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
                    resetBtn.style.display = 'inline-block';
                }
            } catch (e) {
                console.error(e);
                tableContainer.innerHTML = '<div class="empty">–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É</div>';
            }
        }

        resetBtn.addEventListener('click', loadWarehouseGoods);

        // –ö–µ—à –¥–ª—è —ñ–º–µ–Ω —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤ (—â–æ–± –Ω–µ —Ä–æ–±–∏—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ñ –∑–∞–ø–∏—Ç–∏)
        const employeeCache = new Map();

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–º–µ–Ω—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞
        async function getEmployeeName(employeeId) {
            if (!employeeId) {
                console.log('‚ö†Ô∏è employeeId –ø–æ—Ä–æ–∂–Ω—ñ–π');
                return "‚Äî";
            }

            console.log('üë§ –ó–∞–ø–∏—Ç —ñ–º–µ–Ω—ñ –¥–ª—è employeeId:', employeeId);

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–µ—à
            if (employeeCache.has(employeeId)) {
                console.log('üì¶ –í–∑—è—Ç–æ –∑ –∫–µ—à—É:', employeeCache.get(employeeId));
                return employeeCache.get(employeeId);
            }

            try {
                const response = await fetchWithSessionCheck(
                    API + '/api/employee/' + employeeId,
                    { credentials: 'include' }
                );

                if (!response) {
                    console.log('‚ùå –í—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ—Ä–æ–∂–Ω—è');
                    return "‚Äî";
                }

                console.log('üì• –í—ñ–¥–ø–æ–≤—ñ–¥—å API:', response);

                const name = response.success && response.name ? response.name : "‚Äî";
                console.log('‚úÖ –Ü–º\'—è —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞:', name);

                employeeCache.set(employeeId, name);
                return name;
            } catch (e) {
                console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞:', e);
                return "‚Äî";
            }
        }

        async function showHistory(pid, title) {
            const bid = branchSelect.value, wid = warehouseSelect.value;
            // –Ø–∫—â–æ –¥–∞—Ç–∞ –Ω–µ –≤–∏–±—Ä–∞–Ω–∞ - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ 01.05.2022
            const defaultStartDate = new Date('2022-05-01').getTime();
            const s = startDate.value ? new Date(startDate.value).getTime() : defaultStartDate;

            // –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è–º
            historyStats.innerHTML = '<h3>' + title + '</h3>' +
                '<div style="text-align:center; padding:20px;">' +
                '<div class="spinner" style="margin:0 auto 15px; width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid #667eea; border-radius:50%; animation:spin 1s linear infinite;"></div>' +
                '<p style="font-size:16px; margin:10px 0; font-weight:500;">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó...</p>' +
                '<p style="font-size:13px; color:#666; margin:5px 0;">–¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ –¥–æ 3 —Ö–≤–∏–ª–∏–Ω –¥–ª—è —Ç–æ–≤–∞—Ä—ñ–≤ –∑ –≤–µ–ª–∏–∫–æ—é —ñ—Å—Ç–æ—Ä—ñ—î—é</p>' +
                '<p style="font-size:12px; color:#999; margin:5px 0;">–ü–µ—Ä—ñ–æ–¥: –∑ 01.05.2022</p>' +
                '</div>';
            historyContent.innerHTML = '';
            historyModal.style.display = 'block';

            try {
                const startTime = Date.now();

                const d = await fetchWithSessionCheck(
                    API + '/api/goods-history/' + pid + '/' + wid + '?branch_id=' + bid + '&startDate=' + s,
                    { credentials: 'include' }
                );

                if (!d) {
                    historyModal.style.display = 'none';
                    return;
                }

                const loadTime = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log('üìä –û—Ç—Ä–∏–º–∞–Ω–æ –æ–ø–µ—Ä–∞—Ü—ñ–π:', d.operations.length, '–∑–∞', loadTime, '—Å–µ–∫');

                if (d.success && d.operations.length > 0) {
                    let bal = 0;

                    // –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–∞–±–ª–∏—Ü—é –û–î–†–ê–ó–£ –∑ placeholder –¥–ª—è —ñ–º–µ–Ω
                    let h = '<table>';
                    h += '<thead><tr>';
                    h += '<th>–î–∞—Ç–∞</th>';
                    h += '<th>–î–æ–∫—É–º–µ–Ω—Ç</th>';
                    h += '<th>–•—Ç–æ —Å—Ç–≤–æ—Ä–∏–≤</th>';
                    h += '<th>–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</th>';
                    h += '<th>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th>';
                    h += '<th style="text-align:right">–ü—Ä–∏—Ö—ñ–¥</th>';
                    h += '<th style="text-align:right">–í–∏—Ç—Ä–∞—Ç–∞</th>';
                    h += '<th style="text-align:right">–ó–∞–ª–∏—à–æ–∫</th>';
                    h += '</tr></thead>';
                    h += '<tbody>';

                    d.operations.forEach((op, index) => {
                        bal += op.delta;
                        const dt = new Date(op.date).toLocaleDateString('uk-UA');
                        const time = new Date(op.date).toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
                        const pl = op.delta > 0 ? op.delta : '';
                        const mn = op.delta < 0 ? Math.abs(op.delta) : '';

                        h += '<tr>';
                        h += '<td>' + dt + '<br><small style="color:#999">' + time + '</small></td>';
                        h += '<td>' + op.documentId + '</td>';
                        h += '<td class="employee-cell" data-employee-id="' + (op.employeeId || '') + '" data-row="' + index + '">';
                        h += '<span style="color:#999;">‚è≥ ...</span>'; // Placeholder
                        h += '</td>';
                        h += '<td>' + op.type + '</td>';
                        h += '<td>' + op.clientName + '</td>';
                        h += '<td class="plus-value" style="text-align:right">' + (pl ? '+' + pl : '') + '</td>';
                        h += '<td class="minus-value" style="text-align:right">' + (mn ? '-' + mn : '') + '</td>';
                        h += '<td class="balance-cell" style="text-align:right"><strong>' + bal + '</strong></td>';
                        h += '</tr>';
                    });

                    h += '</tbody></table>';
                    historyStats.innerHTML = '<h3>' + title + '</h3><p style="color:#666; font-size:14px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑–∞ ' + loadTime + ' —Å–µ–∫. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ–º–µ–Ω —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤...</p>';
                    historyContent.innerHTML = h;

                    console.log('‚úÖ –¢–∞–±–ª–∏—Ü—è –ø–æ–∫–∞–∑–∞–Ω–∞, –ø–æ—á–∏–Ω–∞—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ–º–µ–Ω...');

                    // –û–ü–¢–ò–ú–Ü–ó–ê–¶–Ü–Ø: –ó–±–∏—Ä–∞—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ ID —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤
                    const uniqueEmployeeIds = [...new Set(
                        d.operations
                            .map(op => op.employeeId)
                            .filter(id => id)
                    )];

                    console.log('üë• –£–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤:', uniqueEmployeeIds.length);

                    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ–º–µ–Ω–∞ –ü–ê–†–ê–õ–ï–õ–¨–ù–û (–≤—Å—ñ –æ–¥–Ω–æ—á–∞—Å–Ω–æ)
                    const employeeStartTime = Date.now();

                    await Promise.all(
                        uniqueEmployeeIds.map(async (employeeId) => {
                            const name = await getEmployeeName(employeeId);

                            // –û–Ω–æ–≤–ª—é—î–º–æ –í–°–Ü –∫–æ–º—ñ—Ä–∫–∏ –∑ —Ü–∏–º employeeId
                            const cells = document.querySelectorAll(`.employee-cell[data-employee-id="${employeeId}"]`);
                            cells.forEach(cell => {
                                cell.innerHTML = '<span class="employee-name">' + name + '</span>';
                            });
                        })
                    );

                    const employeeLoadTime = ((Date.now() - employeeStartTime) / 1000).toFixed(1);
                    console.log('‚úÖ –í—Å—ñ —ñ–º–µ–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑–∞', employeeLoadTime, '—Å–µ–∫');

                    historyStats.innerHTML = '<h3>' + title + '</h3>' +
                        '<p style="color:#666; font-size:14px;">–û–ø–µ—Ä–∞—Ü—ñ–π: ' + d.operations.length + ' | ' +
                        '–Ü—Å—Ç–æ—Ä—ñ—è: ' + loadTime + '—Å | ' +
                        '–Ü–º–µ–Ω–∞: ' + employeeLoadTime + '—Å | ' +
                        '–í—Å—å–æ–≥–æ: ' + ((Date.now() - startTime) / 1000).toFixed(1) + '—Å</p>';

                } else {
                    historyStats.innerHTML = '<h3>' + title + '</h3><p>–ù–µ–º–∞—î –æ–ø–µ—Ä–∞—Ü—ñ–π</p>';
                }
            } catch (e) {
                console.error('‚ùå –ü–æ–º–∏–ª–∫–∞:', e);
                historyContent.innerHTML = '<p style="color:red; padding:20px; text-align:center;">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó</p>';
            }
        }

        closeModal.addEventListener('click', () => { historyModal.style.display = 'none'; });
        historyModal.addEventListener('click', (e) => { if (e.target === historyModal) historyModal.style.display = 'none'; });
    </script>

</body>

</html>